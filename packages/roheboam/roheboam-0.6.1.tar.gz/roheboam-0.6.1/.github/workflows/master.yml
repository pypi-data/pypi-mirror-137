name: Master
on:
  push:
    branches:
      - master

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository code
        uses: actions/checkout@v2
        with:
          fetch-depth: 0
      # - name: Cache packages
      #   uses: actions/cache@v2
      #   with:
      #     path: /usr/local/lib/python3.8/dist-packages
      #     key:  ${{ runner.os }}-pip-${{ hashFiles('requirements/requirements.py') }}
      # - name: Cache packages
      #   uses: actions/cache@v2
      #   with:
      #     path: /usr/lib/python3/dist-packages
      #     key:  ${{ runner.os }}-pip-${{ hashFiles('requirements/requirements.py') }}
      # - name: Cache packages
      #   uses: actions/cache@v2
      #   with:
      #     path: /home/runner/.cache/pip
      #     key:  ${{ runner.os }}-pip-${{ hashFiles('requirements/requirements.py') }}
      - run: sudo apt-get update && sudo apt-get install ffmpeg libsm6 libxext6 libvips-dev -y
      - run: pip install .
      - run: pip install pre-commit pytest pytest-mock python-semantic-release
      - run: pytest tests
      - run: git config --global user.name "github-actions"
      - run: git config --global user.email "action@github.com"
      # - name: Setup tmate session
      #   uses: mxschmitt/action-tmate@v3
      - run: TWINE_USERNAME=__token__ TWINE_PASSWORD=${{ secrets.ROHEBOAM_PYPI_TOKEN }} SKIP=commitizen semantic-release publish
