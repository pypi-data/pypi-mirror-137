apiVersion: v1
kind: Service
metadata:
  name: tiny-dancer
  namespace: tiny-dancer
  labels:
    app: tiny-dancer
spec:
  ports:
  - port: 8080
    name: worker
  clusterIP: None
  selector:
    app: tiny-dancer
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: tiny-dancer
  namespace: tiny-dancer
spec:
  selector:
    matchLabels:
      app: tiny-dancer 
  serviceName: "tiny-dancer"
  replicas: 3
  podManagementPolicy: "Parallel"
  template:
    metadata:
      labels:
        app: tiny-dancer
    spec:
      initContainers:
      - name: init-hostfile
        env:
        - name: REPLICAS
          value: "3"
        image: busybox
        command:
        - sh
        - "-c"
        - |
          set -ex
          # Generate hostfile.txt.
          echo "tiny-dancer-0.tiny-dancer.tiny-dancer.svc.cluster.local:8080" > /etc/tiny-dancer/hostfile.txt
          replicas=$(($REPLICAS-1))
          x=1
          while [ $x -le $replicas ]
          do
            echo "tiny-dancer-$x.tiny-dancer.tiny-dancer.svc.cluster.local:8080" >> /etc/tiny-dancer/hostfile.txt
            x=$(( $x + 1 ))
          done
        volumeMounts:
        - name: hostfile
          mountPath: /etc/tiny-dancer 
      terminationGracePeriodSeconds: 10
      containers:
      - name: worker
        image: 443066169751.dkr.ecr.us-west-2.amazonaws.com/tiny-dancer:alpha-v3
        command: ["sh","-c","sh ./entrypoint.sh && sleep 7200"]
        ports:
        - containerPort: 8080
          name: worker
        env:
        # - name: RUST_LOG
        #   value: "librdkafka=debug,rdkafka::client=debug"
        - name: RUST_BACKTRACE
          value: "full"
        - name: TINYDANCER_PYTHON_FILE_PATH
          value: "./pyexamples/example.py"
        - name: TINYDANCER_WORKERS_PER_PROCESS
          value: "1"
        - name: TINYDANCER_KAFKA_TOPIC
          value: "tiny-dancer-lab-three-partitions"
        - name: TINYDANCER_KAFKA_BROKERS
          value: "kafka.kafka.svc.cluster.local:9092"
        - name: POD_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.name
        - name: REPLICAS
          value: "3"              
        - name: HOSTFILE_PATH
          value: "/etc/tiny-dancer/hostfile.txt"
        volumeMounts:
        - name: hostfile
          mountPath: /etc/tiny-dancer
      volumes:
      - name: hostfile
        emptyDir: {}
