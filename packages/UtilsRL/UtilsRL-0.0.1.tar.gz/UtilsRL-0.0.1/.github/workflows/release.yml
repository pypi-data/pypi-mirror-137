name: build and upload
on: 
  workflow_dispatch: 
  push: 
    tags: 
      - v*

jobs: 
  build_and_upload:
    name: build and upload to pypi
    runs-on: ubuntu-latest
    if: |
      startsWith(github.ref, 'refs/tags/v')
    steps: 
      - name: Checkout
        uses: actions/checkout@v2.3.1

      - name: Set Version
        run: |
          [ "v"`cat VERSION` = ${GITHUB_REF##*/} ] && echo "VERSION=${GITHUB_REF##*/}" >> $GITHUB_ENV
      
      - name: Set up python
        uses: actions/setup-python@v2
        with: 
          python-version: 3.9

      - name: Install dependencies and build
        run: |
          python -m pip install --upgrade pip
          pip install setuptools wheel twine
          python setup.py sdist bdist_wheel
      
      - name: Upload
        uses: pypa/gh-action-pypi-publish@release/v1
        with: 
          user: "__token__"
          password: ${{ secrets.PYPI_TOKEN }}

      # - name: Release
      #   uses: "marvinpinto/action-automatic-releases@latest"
      #   with: 
      #     repo_token: "${{ secrets.GH_TOKEN }}"
      #     prerelease: false
      #     files: |
      #       dist/*


